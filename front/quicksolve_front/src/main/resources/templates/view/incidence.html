<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0"/>
    <title>Title</title>
</head>
<body>
<th:block th:include="view/fragments/sub-incidence-nav"></th:block>

<body>


<div class="container mt-5">
    <div class="row mb-4">

        <div class="col-12 d-flex justify-content-center" th:if="${incidence.incidenceState.id == 4}">
            <div class="alert alert-delete d-flex flex-nowrap align-items-center justify-content-center w-100" role="alert">
                <span class="material-symbols-outlined mx-2">
                    lock
                </span> Esta Incidencia esta &ensp; <strong>cancelada</strong>, no se pueden enviar mensajes.
            </div>
        </div>

        <div class="col-12 d-flex justify-content-center" th:if="${incidence.incidenceState.id == 3}">
            <div class="alert alert-successful d-flex flex-nowrap align-items-center justify-content-center w-100" role="alert">
                <span class="material-symbols-outlined mx-2">
                    lock
                </span> Esta Incidencia esta &ensp;<strong>resuelta</strong> , no se pueden enviar mensajes.
            </div>
        </div>
    </div>

        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 th:text="${incidence.title}"></h2>
                <div id="actions" class="d-flex align-items-center ">
                    <!-- <button class="btn btn-primary mx-2">Finalizar</button> -->
                    <span th:if="${incidence.incidenceState.id == 1}" class="badge text-texto-contraste text-bg-white-low-opacity text-nowrap fs-5">En Espera</span>
                    <span th:if="${incidence.incidenceState.id == 2}" class="badge text-texto-contraste text-bg-primary text-nowrap fs-5">En Progreso</span>
                    <span th:if="${incidence.incidenceState.id == 3}" class="badge text-texto-contraste text-bg-successful text-nowrap fs-5">Solucionada</span>
                    <span th:if="${incidence.incidenceState.id == 4}" class="badge text-texto-contraste text-bg-delete text-nowrap fs-5">Cancelada</span>
                </div>
            </div>
        </div>

    <div class="col-12">
        <!--TODO poner el usuario propietario de la incidencia  -->
        <p th:if="${userlogin.type == T(com.quicksolve.proyecto.entity.type.UserType).TECH}" th:text="${incidence.user} ?  'Enviado por: ' + ${incidence.user.username} : 'Enviado por: ' + ${incidence.email}"></p>

    </div>

    <hr>


    <div class="row align-items-center mb-4">
        <div class="col-12 col-lg-6 p-4">
            <p th:text="${incidence.description}"></p>
        </div>

        <div class="col-12 col-lg-6 d-flex justify-content-center">
            <h3>Esta incidencia no tiene imagenes.</h3>
        </div>
    </div>

    <hr>

    <h5 th:if="${#lists.isEmpty(incidence.messages)} and ${incidence.user != null}" class="w-100 text-center">De momento no hay ningun mensaje...</h5>

    <div class="row justify-content-center mb-5">
        <div class="col-12 mt-3 mb-5">

            <div class="card-comment p-3 mb-4" th:each="message : ${incidence.messages}" th:class="${message.action} ? 'card-comment p-3 mb-4 bg-secondary' : 'card-comment p-3 mb-4'">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="user d-flex flex-row align-items-center">
                        <img th:src="@{/img/user.png}" width="30" alt="" class="user-img rounded-circle mx-3">
                        <span>
                            <small th:if="${message.userNameUser == userlogin.username}"  th:text="'(Tú)'" class="font-weight-bold fs-5"></small>
                            <small th:if="${message.userNameTech == userlogin.username}"  th:text="'(Tú)'" class="font-weight-bold fs-5"></small>
                            <small  th:if="${message.userNameTech != userlogin.username}"  th:text="${message.userNameUser}" class="font-weight-bold fs-5"></small>
                            <small th:if="${message.userNameUser != userlogin.username}"  th:text="${message.userNameTech}" class="font-weight-bold fs-5"></small>
                            <br>
                                <p th:class="${message.action} ? 'font-weight-bold bg-secondary text-darker fs-5' : 'font-weight-bold fs-5'" th:text="${message.body}"></p>
                            </span>
                    </div>
                    <small>2 days ago</small>

                </div>

                <div class="action d-flex justify-content-start mt-2 align-items-center">
                    <div class="reply px-4">
                        <a
                                th:class="${message.action} ? 'font-weight-bold bg-secondary text-darker mx-2 text-decoration-none' : 'font-weight-bold mx-2 text-decoration-none'"
                                th:if="${message.userNameUser == userlogin.username and incidence.incidenceState.id != 3 and incidence.incidenceState.id != 4}"
                                th:href="@{/borrar/mensaje/} + ${incidence.id} +'/'+ ${message.id}">Eliminar
                        </a>
                        <a
                                th:class="${message.action} ? 'font-weight-bold bg-secondary text-darker mx-2 text-decoration-none' : 'font-weight-bold mx-2 text-decoration-none'"
                                th:if="${message.userNameTech == userlogin.username and  incidence.incidenceState.id != 3 and incidence.incidenceState.id != 4}"
                                th:href="@{/borrar/mensaje/} + ${incidence.id} +'/'+ ${message.id}">Eliminar
                        </a>
                        <a
                                th:class="${message.action} ? 'font-weight-bold bg-secondary text-darker mx-2 text-decoration-none' : 'font-weight-bold mx-2 text-decoration-none'"
                                th:if="${message.userNameUser == userlogin.username and incidence.incidenceState.id != 3 and incidence.incidenceState.id != 4}"
                                th:href="@{/editar/mensaje/} + ${incidence.id} +'/'+ ${message.id}">Modificar
                        </a>
                        <a
                                th:class="${message.action} ? 'font-weight-bold bg-secondary text-darker text-decoration-none' : 'font-weight-bold text-decoration-none'"
                                th:if="${message.userNameTech == userlogin.username and incidence.incidenceState.id != 3 and incidence.incidenceState.id != 4}"
                                th:href="@{/editar/mensaje/} + ${incidence.id} +'/'+ ${message.id}">Modificar
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 mt- mb-5" th:if="${incidence.incidenceState.id != 3 and incidence.incidenceState.id != 4} and ${incidence.user != null}">
            <div id="message" class="card-comment p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="user d-flex flex-row align-items-center w-100">
                        <form th:if="!${isUpdateMessage}" th:action="@{/guardar/mensaje/{incidenceId}(incidenceId=${incidence.id})}" method="POST" th:object="${newMessage}" class="w-100">

                            <div class="d-flex justify-content-between">
                                <p class="fs-6 w-50">Nuevo Mensaje</p>

                                <div class="w-50 d-flex justify-content-end"  th:if="${userlogin.type == T(com.quicksolve.proyecto.entity.type.UserType).TECH}">
                                    <label for="action" class="mx-2">
                                        Es una acción?
                                    </label>
                                    <input type="checkbox" name="isAction" th:field="*{action}" th:value="*{action}" id="action">
                                </div>
                            </div>


                            <div class="form-floating">
                                    <textarea  th:field="*{body}" th:value="*{body}" class="form-control" placeholder="Envia tu mensaje..."
                                              id="messageUser"></textarea>
                                <label for="messageUser">Mensaje</label>
                            </div>

                            <div class="d-flex justify-content-end w-100">
                                <button class="btn btn-secondary mt-2">ENVIAR</button>
                            </div>
                        </form>


                        <form th:if="${isUpdateMessage}" th:action="@{/editar/mensaje/{incidenceId}(incidenceId=${incidence.id})} + '/' + ${message.id}" method="POST" th:object="${message}" class="w-100">

                            <div class="d-flex justify-content-between">
                                <p class="fs-6 w-50">Nuevo Mensaje</p>

                                <div class="w-50 d-flex justify-content-end">
                                    <label for="actionUpdate" class="mx-2">
                                        Es una acción?
                                    </label>
                                    <input type="checkbox" id="actionUpdate" th:if="${userlogin.type == T(com.quicksolve.proyecto.entity.type.UserType).TECH}" name="isAction" th:field="*{action}" th:value="*{action}">
                                </div>
                            </div>


                            <div class="form-floating">
                                    <textarea  th:field="*{body}" th:value="*{body}" class="form-control" placeholder="Envia tu mensaje..."
                                               id="messageUserUpdate"></textarea>
                                <label for="messageUser">Mensaje</label>
                            </div>

                            <div class="d-flex justify-content-end w-100">
                                <button class="btn btn-secondary mt-2">ENVIAR</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/js/jquery-3.6.3-min.js}"></script>
<script th:src="@{/js/activeLinks.js}"></script>

</body>
</html>